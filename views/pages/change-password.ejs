<%- layout('layouts/main') %>

<section style="min-height: calc(100vh - 100px); padding: 3rem 1rem;">
	<div style="max-width: 700px; margin: 0 auto;">
		<a href="/profile" style="color: var(--primary-color); text-decoration: none; font-size: 0.875rem;">‚Üê Back to Profile</a>
		<h1 style="font-size: 2rem; margin: 1rem 0 0.5rem 0;">Security Settings</h1>
		<p style="color: var(--text-light); margin-bottom: 2rem;">Manage your password and account security</p>

                <form id="changePasswordForm" method="POST" action="/profile/change-password" style="background: var(--white); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow); margin-top: 0;">
			<h2 style="font-size: 1.25rem; margin: 0 0 1.5rem 0;"><i class="fas fa-key"></i> Change Password</h2>
                        <% if (error) { %>
                            <div class="error-alert" style="margin-bottom: 1rem;">
                                <p><i class="fas fa-exclamation-triangle" aria-hidden="true"></i> <%= error %></p>
                            </div>
                        <% } %>
			<div style="margin-bottom: 1.5rem;">
				<label style="display: block; color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">Current Password</label>
				<div class="password-field">
					<input 
						type="password" 
						id="currentPassword"
						name="currentPassword" 
						required 
						autocomplete="current-password"
						class="form-input with-toggle"
						style="width: 100%; padding: 0.75rem; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; background: rgba(0,0,0,0.2); color: var(--text-dark); box-sizing: border-box; font-size: 1rem;"
					>
					<button type="button" class="password-toggle" aria-label="Toggle password visibility">
						<i class="fas fa-eye"></i>
					</button>
				</div>
				<span class="error-message" id="currentPasswordError" style="color: #fca5a5; font-size: 0.75rem; margin-top: 0.25rem; display: block;"></span>
			</div>

			<div style="margin-bottom: 1.5rem;">
				<label style="display: block; color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">New Password</label>
				<div class="password-field">
					<input 
						type="password" 
						id="newPassword"
						name="newPassword" 
						required 
						minlength="8" 
						maxlength="128"
						autocomplete="new-password"
						class="form-input with-toggle"
						style="width: 100%; padding: 0.75rem; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; background: rgba(0,0,0,0.2); color: var(--text-dark); box-sizing: border-box; font-size: 1rem;"
					>
					<button type="button" class="password-toggle" aria-label="Toggle password visibility">
						<i class="fas fa-eye"></i>
					</button>
				</div>
				<p style="color: var(--text-light); font-size: 0.75rem; margin: 0.5rem 0 0 0;">8+ chars, include upper, lower, and a number.</p>
				<span class="error-message" id="newPasswordError" style="color: #fca5a5; font-size: 0.75rem; margin-top: 0.25rem; display: block;"></span>
			</div>

			<div style="margin-bottom: 1.5rem;">
				<label style="display: block; color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">Confirm Password</label>
				<div class="password-field">
					<input 
						type="password" 
						id="confirmPassword"
						name="confirmPassword" 
						required 
						autocomplete="new-password"
						class="form-input with-toggle"
						style="width: 100%; padding: 0.75rem; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; background: rgba(0,0,0,0.2); color: var(--text-dark); box-sizing: border-box; font-size: 1rem;"
					>
					<button type="button" class="password-toggle" aria-label="Toggle password visibility">
						<i class="fas fa-eye"></i>
					</button>
				</div>
				<span class="error-message" id="confirmPasswordError" style="color: #fca5a5; font-size: 0.75rem; margin-top: 0.25rem; display: block;"></span>
			</div>

			<div style="display: flex; gap: 1rem; justify-content: flex-start;">
				<button type="submit" class="btn btn-primary">Update Password</button>
				<a href="/profile" class="btn" style="background: rgba(255,255,255,0.1); color: var(--text-dark); text-decoration: none; padding: 0.75rem 1.5rem; border-radius: 8px;">Cancel</a>
			</div>
		</form>

		<!-- Delete Account Section -->
		<div style="background: var(--white); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow); margin-top: 2rem; border-left: 4px solid #ef4444;">
			<h2 style="font-size: 1.25rem; margin: 0 0 1rem 0; color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Danger Zone</h2>
			<p style="color: var(--text-light); margin-bottom: 1.5rem;">Delete your account and all associated data. This action cannot be undone.</p>
            <button id="deleteAccountBtn" class="btn" style="background: #ef4444; color: white; border: none;">
				<i class="fas fa-trash-alt"></i> Delete Account
			</button>
		</div>
	</div>
</section>

<script>
// Delete account with confirmation
async function confirmDeleteAccount() {
    const confirmed = await showConfirm('Are you sure you want to delete your account? This will delete all your files and account data. This action cannot be undone.');
    if (!confirmed) return;

    try {
        const res = await fetch('/profile/delete-account', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (data.success) {
            showSuccess('Account deleted successfully. Redirecting...');
            setTimeout(() => window.location.href = '/', 1500);
        } else {
            showError(data.error || 'Failed to delete account');
        }
    } catch (err) {
        console.error('Delete account error:', err);
        showError('Failed to delete account');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    // Password visibility toggle
    document.querySelectorAll('.password-toggle').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const input = this.previousElementSibling;
            const icon = this.querySelector('i');
            const isHidden = input.type === 'password';
            input.type = isHidden ? 'text' : 'password';
            icon.classList.toggle('fa-eye', !isHidden);
            icon.classList.toggle('fa-eye-slash', isHidden);
        });
    });

    const currentPasswordInput = document.getElementById('currentPassword');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const currentPasswordError = document.getElementById('currentPasswordError');
    const newPasswordError = document.getElementById('newPasswordError');
    const confirmPasswordError = document.getElementById('confirmPasswordError');

    function validatePassword(pwd) {
        const errors = [];
        if (!pwd) return errors;
        if (pwd.length < 8) errors.push('At least 8 characters');
        if (!/[A-Z]/.test(pwd)) errors.push('1 uppercase letter');
        if (!/[a-z]/.test(pwd)) errors.push('1 lowercase letter');
        if (!/[0-9]/.test(pwd)) errors.push('1 number');
        return errors;
    }

    newPasswordInput.addEventListener('input', function() {
        const errors = validatePassword(this.value);
        if (errors.length > 0) {
            newPasswordError.textContent = 'Missing: ' + errors.join(', ');
            this.style.borderColor = '#fca5a5';
        } else {
            newPasswordError.textContent = '';
            this.style.borderColor = '';
        }
        if (confirmPasswordInput.value) {
            confirmPasswordInput.dispatchEvent(new Event('input'));
        }
    });

    confirmPasswordInput.addEventListener('input', function() {
        if (this.value !== newPasswordInput.value) {
            confirmPasswordError.textContent = 'Passwords do not match';
            this.style.borderColor = '#fca5a5';
        } else {
            confirmPasswordError.textContent = '';
            this.style.borderColor = '';
        }
    });

    document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
        const currentPassword = currentPasswordInput.value;
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        let isValid = true;

        if (!currentPassword) {
            currentPasswordError.textContent = 'Current password is required';
            currentPasswordInput.style.borderColor = '#fca5a5';
            isValid = false;
        } else {
            currentPasswordError.textContent = '';
            currentPasswordInput.style.borderColor = '';
        }

        const newPasswordErrors = validatePassword(newPassword);
        if (newPasswordErrors.length > 0) {
            newPasswordError.textContent = 'Missing: ' + newPasswordErrors.join(', ');
            newPasswordInput.style.borderColor = '#fca5a5';
            isValid = false;
        }

        if (newPassword !== confirmPassword) {
            confirmPasswordError.textContent = 'Passwords do not match';
            confirmPasswordInput.style.borderColor = '#fca5a5';
            isValid = false;
        }

        if (!isValid) {
            e.preventDefault();
        }
    });

    // Show server-side error inline if provided
    const serverError = <%- JSON.stringify(error || "") %>;
    if (serverError && currentPasswordError) {
        currentPasswordError.textContent = serverError;
        currentPasswordInput.style.borderColor = '#fca5a5';
    }

    // Bind delete account button (CSP-friendly)
    const btn = document.getElementById('deleteAccountBtn');
    if (btn) btn.addEventListener('click', confirmDeleteAccount);
});
</script>
