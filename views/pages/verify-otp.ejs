<%- layout('layouts/main') %>

<div class="auth-container">
    <div class="auth-card">
        <h2 class="auth-title">Verify OTP</h2>
        <p class="auth-subtitle">Enter the 6-digit code sent to <%= email %></p>

        <% const errorText = typeof error !== 'undefined' && error ? String(error) : ''; %>
        <% const suppressErrorAlert = errorText.toLowerCase().includes('expired') && Number(initialCountdown || 0) <= 0; %>

        <% if (errorText && !suppressErrorAlert) { %>
            <div class="error-alert">
                <p><i class="fas fa-exclamation-triangle" aria-hidden="true"></i> <%= errorText %></p>
            </div>
        <% } %>

        <form id="verifyOTPForm" class="auth-form" action="/user/verify-otp" method="POST">
            <input type="hidden" name="email" value="<%= email %>">
            <input type="hidden" name="type" value="<%= type %>">
            
            <div class="form-group">
                <label for="otp" class="form-label">OTP Code</label>
                <input 
                    type="text" 
                    id="otp" 
                    name="otp" 
                    class="form-input"
                    placeholder="6-digit verification code"
                    maxlength="6"
                    style="letter-spacing: 4px; text-transform: uppercase; text-align: center; font-size: 1.2rem; font-weight: 700;"
                    required
                    autocomplete="off"
                >
                <span class="error-message" id="otpError"></span>
            </div>

            <div id="timerNotice" style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 0.85rem; border-radius: 6px; margin-bottom: 1rem;">
                <p style="color: #92400e; margin: 0; font-size: 0.85rem;">
                    <i class="fas fa-clock"></i> <strong>Time remaining:</strong> <span id="countdown"><%= typeof initialCountdown !== 'undefined' ? initialCountdown : 0 %></span> seconds
                </p>
            </div>

            <button type="submit" class="btn-primary btn-full" id="verifyBtn">
                Verify OTP
            </button>

            <div id="expiredNotice" style="display: none; margin-top: 0.5rem; color: #f59e0b; text-align: center; padding: 0.2rem 0 0.8rem; font-size: 0.95rem; font-weight: 700;">
                <i class="fas fa-clock" aria-hidden="true"></i> OTP expired, please resend a new code.
            </div>

            <button type="button" class="btn-primary btn-full" id="resendBtn" style="background: var(--primary-color); display: none; margin-top: 0.5rem;">
                Resend OTP
            </button>
        </form>

        <div class="auth-footer">
            <p><a href="/user/login" class="auth-link">Back to Login</a></p>
        </div>
    </div>
</div>

<script>
const initialCountdown = Number('<%= typeof initialCountdown !== "undefined" ? initialCountdown : 0 %>');
const otpExpiresAtMs = Number('<%= typeof otpExpiresAtMs !== "undefined" ? otpExpiresAtMs : 0 %>');
let timeLeft = initialCountdown;
const countdownEl = document.getElementById('countdown');
const timerNotice = document.getElementById('timerNotice');
const verifyBtn = document.getElementById('verifyBtn');
const expiredNotice = document.getElementById('expiredNotice');
const resendBtn = document.getElementById('resendBtn');
const otpInput = document.getElementById('otp');
const email = document.querySelector('input[name="email"]').value;
const type = document.querySelector('input[name="type"]').value;
const syncKey = `otp-resend-sync-${email}-${type}`;

const getRemainingSeconds = () => {
    if (!otpExpiresAtMs) return 0;
    const remainingMs = otpExpiresAtMs - Date.now();
    return remainingMs > 0 ? Math.ceil(remainingMs / 1000) : 0;
};

const setExpiredState = () => {
    timerNotice.style.display = 'none';
    verifyBtn.style.display = 'none';
    expiredNotice.style.display = 'block';
    otpInput.disabled = true;
    resendBtn.style.display = 'block';
};

if (timeLeft <= 0 || getRemainingSeconds() <= 0) {
    setExpiredState();
}

const countdown = setInterval(() => {
    timeLeft = getRemainingSeconds();

    if (timeLeft <= 0) {
        clearInterval(countdown);
        countdownEl.textContent = '0';
        setExpiredState();
        return;
    }

    countdownEl.textContent = timeLeft;
}, 1000);

resendBtn.addEventListener('click', async () => {
    resendBtn.disabled = true;
    resendBtn.textContent = 'Sending...';
    
    try {
        const response = await fetch('/user/resend-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, type })
        });
        
        if (response.ok) {
            localStorage.setItem(syncKey, String(Date.now()));
            window.location.reload();
        } else {
            let message = 'Failed to resend OTP. Please try again.';
            try {
                const data = await response.json();
                if (data && data.message) {
                    message = data.message;
                }
            } catch (e) {}

            alert(message);
            resendBtn.disabled = false;
            resendBtn.textContent = 'Resend OTP';
        }
    } catch (error) {
        alert('Error resending OTP');
        resendBtn.disabled = false;
        resendBtn.textContent = 'Resend OTP';
    }
});

window.addEventListener('storage', (event) => {
    if (event.key === syncKey && event.newValue) {
        window.location.reload();
    }
});

// Auto-format OTP input
otpInput.addEventListener('input', (e) => {
    e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
});
</script>
