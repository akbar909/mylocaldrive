<%- layout('layouts/main') %>

<section style="min-height: calc(100vh - 100px); padding: 3rem 1rem;">
	<div style="max-width: 1200px; margin: 0 auto;">
		<!-- Header -->
		<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
			<div>
				<a href="/dashboard" style="color: var(--primary-color); text-decoration: none; font-size: 0.875rem;"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
				<h1 style="font-size: 2.5rem; margin: 1rem 0 0.5rem 0;">My Files</h1>
				<p style="color: var(--text-light);">Upload, manage, and share your files securely</p>
			</div>
			<button id="filesUploadBtn" class="btn btn-primary" style="padding: 0.75rem 1.5rem; white-space: nowrap;"><i class="fas fa-cloud-upload-alt"></i> Upload</button>
		</div>

		<!-- Files List -->
		<div style="background: var(--white); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow);">
			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
				<h3 style="margin: 0;">Your Files</h3>
				
				<!-- Sort Controls -->
				<div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
					<span style="color: var(--text-light); font-size: 0.875rem;">Sort by:</span>
					<select id="sortSelect" style="padding: 0.5rem 0.75rem; background: #1f2937; color: white; border: 1px solid rgba(129, 140, 248, 0.3); border-radius: 6px; cursor: pointer;">
						<option value="date" <%= currentSort === 'date' ? 'selected' : '' %>>Newest First</option>
						<option value="oldest" <%= currentSort === 'oldest' ? 'selected' : '' %>>Oldest First</option>
						<option value="name" <%= currentSort === 'name' ? 'selected' : '' %>>Name (A-Z)</option>
						<option value="size" <%= currentSort === 'size' ? 'selected' : '' %>>Size (Large First)</option>
					</select>
				</div>
			</div>

			<% if (files && files.length > 0) { %>
				<div style="overflow-x: auto;">
					<table style="width: 100%; border-collapse: collapse;">
						<thead>
							<tr style="border-bottom: 2px solid var(--gray-200);">
								<th style="text-align: left; padding: 1rem; color: var(--text-light);">File Name</th>
								<th style="text-align: left; padding: 1rem; color: var(--text-light);">Size</th>
								<th style="text-align: left; padding: 1rem; color: var(--text-light);">Uploaded</th>
								<th style="text-align: center; padding: 1rem; color: var(--text-light);">Actions</th>
							</tr>
						</thead>
						<tbody>
							<% files.forEach(file => { %>
								<tr style="border-bottom: 1px solid var(--gray-100); transition: background 0.2s ease;">
									<td style="padding: 1rem; color: var(--text-dark); max-width: 360px;">
										<div style="display: flex; align-items: center; gap: 0.5rem; min-width: 0;">
											<i class="fas fa-file" style="flex-shrink: 0;"></i>
											<span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; width: 100%;" title="<%= file.originalName %>"><%= file.originalName %></span>
										</div>
									</td>
									<td style="padding: 1rem; color: var(--text-dark);">
										<% 
											let size = file.fileSize; 
											let sizeStr = '';
											if (size < 1024) sizeStr = size + ' B';
											else if (size < 1024 * 1024) sizeStr = (size / 1024).toFixed(2) + ' KB';
											else if (size < 1024 * 1024 * 1024) sizeStr = (size / (1024 * 1024)).toFixed(2) + ' MB';
											else sizeStr = (size / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
										%>
										<%= sizeStr %>
									</td>
									<td style="padding: 1rem; color: var(--text-dark);">
										<%= new Date(file.uploadedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) %>
									</td>
									<td style="padding: 1rem; text-align: center;">
										<button class="file-action-btn" data-action="details" data-file-id="<%= file._id %>" data-file-name="<%= file.originalName %>" data-file-size="<%= file.fileSize %>" data-upload-date="<%= new Date(file.uploadedAt).toISOString() %>" style="background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 1rem; margin: 0 0.5rem;" title="File Details"><i class="fas fa-info-circle"></i></button>
										<a href="/files/<%= file._id %>" style="color: var(--primary-color); text-decoration: none; margin: 0 0.5rem;" title="Download"><i class="fas fa-download"></i></a>
										<button class="file-action-btn" data-action="delete" data-file-id="<%= file._id %>" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1rem; margin: 0 0.5rem;" title="Delete"><i class="fas fa-trash"></i></button>
										<button class="file-action-btn" data-action="rename" data-file-id="<%= file._id %>" data-file-name="<%= file.originalName %>" style="background: none; border: none; color: #f59e0b; cursor: pointer; font-size: 1rem; margin: 0 0.5rem;" title="Rename"><i class="fas fa-edit"></i></button>
										<button class="file-action-btn" data-action="share" data-file-id="<%= file._id %>" style="background: none; border: none; color: #10b981; cursor: pointer; font-size: 1rem; margin: 0 0.5rem;" title="Share"><i class="fas fa-share-alt"></i></button>
									</td>
								</tr>
							<% }); %>
						</tbody>
					</table>
				</div>

				<!-- Pagination -->
				<% if (pagination.totalPages > 1) { %>
					<div style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 1.5rem; flex-wrap: wrap;">
						<% if (pagination.hasPrevPage) { %>
							<a href="/files?sort=<%= currentSort %>&page=<%= pagination.currentPage - 1 %>" class="btn" style="padding: 0.5rem 1rem; background: var(--primary-color); color: white; border-radius: 6px; text-decoration: none; cursor: pointer;">
								<i class="fas fa-chevron-left"></i> Previous
							</a>
						<% } %>
						
						<div style="display: flex; gap: 0.25rem;">
							<% for (let i = 1; i <= pagination.totalPages; i++) { %>
								<% if (i === pagination.currentPage) { %>
									<span style="padding: 0.5rem 0.75rem; background: var(--primary-color); color: white; border-radius: 6px; font-weight: bold;"><%= i %></span>
								<% } else { %>
									<a href="/files?sort=<%= currentSort %>&page=<%= i %>" style="padding: 0.5rem 0.75rem; background: #1f2937; color: white; border-radius: 6px; text-decoration: none; cursor: pointer;">
										<%= i %>
									</a>
								<% } %>
							<% } %>
						</div>
						
						<% if (pagination.hasNextPage) { %>
							<a href="/files?sort=<%= currentSort %>&page=<%= pagination.currentPage + 1 %>" class="btn" style="padding: 0.5rem 1rem; background: var(--primary-color); color: white; border-radius: 6px; text-decoration: none; cursor: pointer;">
								Next <i class="fas fa-chevron-right"></i>
							</a>
						<% } %>
					</div>
				<% } %>
			<% } else { %>
				<div style="text-align: center; padding: 3rem 2rem; color: var(--text-light);">
					<p style="font-size: 2rem;"><i class="fas fa-folder-open"></i></p>
					<p>No files uploaded yet.</p>
					<button id="filesUploadEmptyBtn" class="btn btn-primary" style="margin-top: 1rem;"><i class="fas fa-cloud-upload-alt"></i> Upload Your First File</button>
				</div>
			<% } %>
		</div>

		<!-- Recycle Bin -->
		<div style="background: var(--white); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow); margin-top: 2rem;">
			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 0.75rem;">
				<h3 style="margin: 0;">Recycle Bin</h3>
				<p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">Files stay here until permanently deleted.</p>
			</div>
			<% if (trashedFiles && trashedFiles.length > 0) { %>
				<!-- Bulk Actions -->
				<div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: rgba(129, 140, 248, 0.05); border-radius: 8px; align-items: center; flex-wrap: wrap;">
					<label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0;">
					<input type="checkbox" id="selectAllTrash" style="width: 18px; height: 18px; cursor: pointer;">
					<span style="color: var(--text-dark); font-weight: 500;">Select All</span>
				</label>
				<span id="trashSelectedCount" style="color: var(--text-light); font-size: 0.9rem; margin-left: auto;">0 selected</span>
				<button id="bulkDeleteBtn" class="btn trash-action-btn" data-trash-action="bulkDelete" style="padding: 0.5rem 1rem; background: #ef4444; border: none; color: white; border-radius: 8px; cursor: pointer; display: none;">
					<i class="fas fa-trash-alt"></i> Delete Selected
				</button>
				<button id="bulkRestoreBtn" class="btn trash-action-btn" data-trash-action="bulkRestore" style="padding: 0.5rem 1rem; background: #10b981; border: none; color: white; border-radius: 8px; cursor: pointer; display: none;">
						<i class="fas fa-undo"></i> Restore Selected
					</button>
				</div>

				<div style="overflow-x: auto;">
					<table style="width: 100%; border-collapse: collapse;">
						<thead>
							<tr style="border-bottom: 2px solid var(--gray-200);">
								<th style="text-align: center; padding: 1rem; color: var(--text-light); width: 50px;"><i class="fas fa-check-square"></i></th>
								<th style="text-align: left; padding: 1rem; color: var(--text-light);">File Name</th>
								<th style="text-align: left; padding: 1rem; color: var(--text-light);">Size</th>
								<th style="text-align: left; padding: 1rem; color: var(--text-light);">Deleted</th>
								<th style="text-align: center; padding: 1rem; color: var(--text-light);">Actions</th>
							</tr>
						</thead>
						<tbody>
							<% trashedFiles.forEach(file => { %>
								<tr style="border-bottom: 1px solid var(--gray-100);">
																		<td style="padding: 1rem; text-align: center;">
																		<input type="checkbox" class="trashCheckbox" value="<%= file._id %>" style="width: 18px; height: 18px; cursor: pointer;">
																		</td>
									<td style="padding: 1rem; color: var(--text-dark); max-width: 340px;">
										<div style="display: flex; align-items: center; gap: 0.5rem; min-width: 0;">
											<i class="fas fa-trash" style="color: #ef4444; flex-shrink: 0;"></i>
											<span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; width: 100%;" title="<%= file.originalName %>"><%= file.originalName %></span>
										</div>
									</td>
									<td style="padding: 1rem; color: var(--text-dark);">
										<%
											let size = file.fileSize;
											let sizeStr = '';
											if (size < 1024) sizeStr = size + ' B';
											else if (size < 1024 * 1024) sizeStr = (size / 1024).toFixed(2) + ' KB';
											else if (size < 1024 * 1024 * 1024) sizeStr = (size / (1024 * 1024)).toFixed(2) + ' MB';
											else sizeStr = (size / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
										%>
										<%= sizeStr %>
									</td>
									<td style="padding: 1rem; color: var(--text-dark);">
										<%= new Date(file.deletedAt || file.updatedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) %>
									</td>
									<td style="padding: 1rem; text-align: center; display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
									<button class="btn trash-action-btn" data-trash-action="restore" data-file-id="<%= file._id %>" style="padding: 0.5rem 1rem; background: #10b981; border: none; color: white; border-radius: 8px; cursor: pointer;">
										<i class="fas fa-undo"></i> Restore
									</button>
									<button class="btn trash-action-btn" data-trash-action="deleteForever" data-file-id="<%= file._id %>" style="padding: 0.5rem 1rem; background: #ef4444; border: none; color: white; border-radius: 8px; cursor: pointer;">
											<i class="fas fa-skull-crossbones"></i> Delete Forever
										</button>
									</td>
								</tr>
							<% }); %>
						</tbody>
					</table>
				</div>
			<% } else { %>
				<div style="text-align: center; padding: 2rem; color: var(--text-light);">
					<p><i class="fas fa-check-circle"></i> Recycle Bin is empty.</p>
				</div>
			<% } %>
		</div>
	</div>
</section>

<!-- Include shared file modals -->
<%- include('../partials/file-modals') %>

<script>
	// Toast notification functions - Define FIRST before file-operations.js loads
	function showError(msg) {
		console.error('Error:', msg);
		alert('Error: ' + msg);
	}

	function showSuccess(msg) {
		console.log('Success:', msg);
		alert('Success: ' + msg);
	}

	// Expose globally BEFORE file-operations.js
	window.showError = showError;
	window.showSuccess = showSuccess;
	
	console.log('[Files Page] Helper functions initialized');
</script>

<!-- Load shared file operations AFTER helper functions -->
<script src="/js/file-operations.js"></script>

<script>
	// Event delegation for all button types
	document.addEventListener('click', (e) => {
		// Handle file action buttons
		const actionBtn = e.target.closest('.file-action-btn');
		if (actionBtn) {
			e.preventDefault();
			const action = actionBtn.dataset.action;
			const fileId = actionBtn.dataset.fileId;
			const fileName = actionBtn.dataset.fileName;
			const fileSize = actionBtn.dataset.fileSize;
			const uploadDate = actionBtn.dataset.uploadDate;
			
			console.log('[Files Page] Action button clicked:', action, fileId);
			
			switch(action) {
				case 'details':
					if (window.showFileDetails) {
						window.showFileDetails(fileId, fileName, parseInt(fileSize), uploadDate);
					}
					break;
				case 'delete':
					if (window.deleteFile) {
						window.deleteFile(fileId);
					}
					break;
				case 'rename':
					if (window.showRenameModal) {
						window.showRenameModal(fileId, fileName);
					}
					break;
				case 'share':
					if (window.showShareModal) {
						window.showShareModal(fileId);
					}
					break;
			}
			return;
		}
		
		// Handle modal close buttons
		const closeBtn = e.target.closest('.modal-close-btn');
		if (closeBtn) {
			e.preventDefault();
			const modalId = closeBtn.dataset.modal;
			if (modalId) {
				document.getElementById(modalId).style.display = 'none';
				console.log('[Files Page] Closed modal:', modalId);
			}
			return;
		}
		
		// Handle modal action buttons
		const modalActionBtn = e.target.closest('.modal-action-btn');
		if (modalActionBtn) {
			e.preventDefault();
			const action = modalActionBtn.dataset.action;
			console.log('[Files Page] Modal action:', action);
			
			if (action === 'confirmRename' && window.confirmRename) {
				window.confirmRename();
			} else if (action === 'confirmShare' && window.confirmShare) {
				window.confirmShare();
			} else if (action === 'copyShareLink' && window.copyShareLink) {
				window.copyShareLink();
			} else if (action === 'toggleProgressCollapse' && window.toggleProgressCollapse) {
				window.toggleProgressCollapse();
			} else if (action === 'toggleProgressVisibility' && window.toggleProgressVisibility) {
				window.toggleProgressVisibility();
			} else if (action === 'showProgressPanel' && window.toggleProgressVisibility) {
				window.toggleProgressVisibility();
			} else if (action === 'closeProgress' && window.hideProgressPopup) {
				window.hideProgressPopup();
			} else if (action === 'cancelAllUploads' && window.cancelAllUploads) {
				window.cancelAllUploads();
			}
			return;
		}
		
		// Handle trash action buttons
		const trashBtn = e.target.closest('.trash-action-btn');
		if (trashBtn) {
			e.preventDefault();
			const action = trashBtn.dataset.trashAction;
			const fileId = trashBtn.dataset.fileId;
			
			console.log('[Files Page] Trash action:', action, fileId);
			
			if (action === 'restore' && window.restoreFile) {
				window.restoreFile(fileId);
			} else if (action === 'deleteForever' && window.deleteForever) {
				window.deleteForever(fileId);
			} else if (action === 'bulkDelete' && window.bulkDeleteTrash) {
				window.bulkDeleteTrash();
			} else if (action === 'bulkRestore' && window.bulkRestoreTrash) {
				window.bulkRestoreTrash();
			}
			return;
		}
	});
	
	// Handle checkbox changes for trash selection
	document.addEventListener('change', (e) => {
		// Select all trash checkbox
		if (e.target.id === 'selectAllTrash') {
			if (window.toggleSelectAllTrash) {
				window.toggleSelectAllTrash();
			}
			return;
		}
		
		// Individual trash checkboxes
		if (e.target.classList.contains('trashCheckbox')) {
			if (window.updateTrashSelection) {
				window.updateTrashSelection();
			}
			return;
		}
	});
	
	// Verify all functions loaded
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', () => {
			console.log('[Files Page] DOM loaded, verifying functions...');
			const requiredFunctions = ['showFileDetails', 'deleteFile', 'showRenameModal', 'showShareModal', 'uploadFiles', 'restoreFile', 'deleteForever', 'bulkDeleteTrash', 'bulkRestoreTrash', 'toggleSelectAllTrash', 'updateTrashSelection'];
			requiredFunctions.forEach(fn => {
				if (typeof window[fn] !== 'function') {
					console.error(`[Files Page] Missing function: ${fn}`);
				} else {
					console.log(`[Files Page] âœ“ ${fn} loaded`);
				}
			});
		});
	} else {
		console.log('[Files Page] DOM already loaded');
	}
</script>

