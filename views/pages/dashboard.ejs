<%- layout('layouts/main') %>

<section style="min-height: calc(100vh - 100px); padding: 3rem 1rem;">
	<div style="max-width: 1200px; margin: 0 auto;">
		<!-- Hero Section -->
		<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem; flex-wrap: wrap; gap: 1rem;">
			<div>
				<h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">Welcome back, <% if (user && user.firstName) { %><%= user.firstName %><% } else { %><%= user.username %><% } %>! <i class="fas fa-star" style="color: var(--primary-color);"></i></h1>

		<!-- Confirm Modal -->
		<div id="confirmModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1100; align-items: center; justify-content: center;">
			<div style="background: #111827; padding: 1.75rem; border-radius: 12px; max-width: 420px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.55);">
				<h3 style="margin: 0 0 0.75rem 0; color: var(--text-dark);">Please Confirm</h3>
				<p id="confirmMessage" style="margin: 0 0 1.25rem 0; color: var(--text-light); line-height: 1.5;"></p>
				<div style="display: flex; gap: 0.75rem; justify-content: flex-end; flex-wrap: wrap;">
					<button id="confirmCancel" class="btn" style="padding: 0.7rem 1.4rem; background: var(--gray-700); border: none; color: white; border-radius: 8px; cursor: pointer;">Cancel</button>
					<button id="confirmOk" class="btn btn-primary" style="padding: 0.7rem 1.4rem;">Yes, proceed</button>
				</div>
			</div>
		</div>
				<p style="color: var(--text-light); font-size: 1.1rem;">Manage your files, profile, and storage all in one place.</p>
			</div>
			<div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
				<button id="dashboardProfileBtn" class="btn" style="padding: 0.75rem 1.5rem; white-space: nowrap; background: #a78bfa; border: none; color: white; border-radius: 8px; cursor: pointer;"><i class="fas fa-user-circle"></i> Profile</button>
				<button id="dashboardUploadBtn" class="btn" style="padding: 0.75rem 1.5rem; white-space: nowrap; background: #06b6d4; border: none; color: white; border-radius: 8px; cursor: pointer;"><i class="fas fa-cloud-upload-alt"></i> Upload</button>
				<button id="dashboardRefreshBtn" class="btn btn-primary" style="padding: 0.75rem 1.5rem; white-space: nowrap;"><i class="fas fa-sync-alt"></i> Refresh</button>
			</div>
		</div>

		<!-- Quick Stats -->
		<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
			<div style="background: var(--white); padding: 1.75rem; border-radius: 12px; box-shadow: var(--shadow); border-left: 4px solid var(--primary-color);">
				<div style="display: flex; justify-content: space-between; align-items: flex-start;">
					<div>
						<p style="color: var(--text-light); font-size: 0.8rem; margin: 0 0 0.75rem 0; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;"><i class="fas fa-file" aria-hidden="true"></i> Files</p>
						<h2 style="font-size: 2.2rem; margin: 0; font-weight: 700; color: var(--primary-color);"><%= fileCount || 0 %></h2>
					</div>
					<div style="background: rgba(129, 140, 248, 0.1); padding: 0.75rem; border-radius: 8px;">
						<i class="fas fa-folder-open" style="font-size: 1.5rem; color: var(--primary-color);"></i>
					</div>
				</div>
			</div>

			<div style="background: var(--white); padding: 1.75rem; border-radius: 12px; box-shadow: var(--shadow); border-left: 4px solid #a78bfa;">
				<div style="display: flex; justify-content: space-between; align-items: flex-start;">
					<div>
						<p style="color: var(--text-light); font-size: 0.8rem; margin: 0 0 0.75rem 0; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;"><i class="fas fa-chart-pie" aria-hidden="true"></i> Used</p>
						<h2 style="font-size: 2.2rem; margin: 0; font-weight: 700; color: #a78bfa;">
							<% 
								let usedMB = storageUnit === 'GB' ? (parseFloat(storageUsed) * 1024) : 
								             storageUnit === 'MB' ? parseFloat(storageUsed) : 
								             storageUnit === 'KB' ? (parseFloat(storageUsed) / 1024) : 
								             (parseFloat(storageUsed) / (1024 * 1024));
							%>
							<%= usedMB.toFixed(2) %>
						</h2>
						<p style="font-size: 0.75rem; color: var(--text-light); margin: 0.5rem 0 0 0;">of 500 MB</p>
					</div>
					<div style="background: rgba(167, 139, 250, 0.1); padding: 0.75rem; border-radius: 8px;">
						<i class="fas fa-database" style="font-size: 1.5rem; color: #a78bfa;"></i>
					</div>
				</div>
			</div>

			<div style="background: var(--white); padding: 1.75rem; border-radius: 12px; box-shadow: var(--shadow); border-left: 4px solid #06b6d4;">
				<div style="display: flex; justify-content: space-between; align-items: flex-start;">
					<div>
						<p style="color: var(--text-light); font-size: 0.8rem; margin: 0 0 0.75rem 0; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;"><i class="fas fa-tachometer-alt" aria-hidden="true"></i> Remaining</p>
						<h2 style="font-size: 2.2rem; margin: 0; font-weight: 700; color: #06b6d4;">
							<% 
								let usedMB2 = storageUnit === 'GB' ? (parseFloat(storageUsed) * 1024) : 
								              storageUnit === 'MB' ? parseFloat(storageUsed) : 
								              storageUnit === 'KB' ? (parseFloat(storageUsed) / 1024) : 
								              (parseFloat(storageUsed) / (1024 * 1024));
								const remaining = (500 - usedMB2).toFixed(2);
							%>
							<%= Math.max(0, remaining) %>
						</h2>
						<p style="font-size: 0.75rem; color: var(--text-light); margin: 0.5rem 0 0 0;">MB available</p>
					</div>
					<div style="background: rgba(6, 182, 212, 0.1); padding: 0.75rem; border-radius: 8px;">
						<i class="fas fa-hdd" style="font-size: 1.5rem; color: #06b6d4;"></i>
					</div>
				</div>
			</div>
		</div>

		<!-- Recent Files -->
		<div style="background: var(--white); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow);">
			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
				<h3 style="margin: 0;">Recent Files</h3>
				<a href="/files" style="color: var(--primary-color); text-decoration: none; font-size: 0.9rem;"><i class="fas fa-folder-open"></i> View All Files</a>
			</div>
			<% if (files && files.length > 0) { %>
				<div style="overflow-x: auto;">
					<table style="width: 100%; border-collapse: collapse;">
						<thead>
							<tr style="border-bottom: 2px solid var(--gray-200);">
								<th style="text-align: left; padding: 1rem; color: var(--text-light); width: 50px;">#</th>
								<th style="text-align: left; padding: 1rem; color: var(--text-light);">File Name</th>
								<th style="text-align: left; padding: 1rem; color: var(--text-light);">Size</th>
								<th style="text-align: left; padding: 1rem; color: var(--text-light);">Uploaded</th>
								<th style="text-align: center; padding: 1rem; color: var(--text-light);">Actions</th>
							</tr>
						</thead>
						<tbody>
							<% files.forEach((file, idx) => { %>
								<tr style="border-bottom: 1px solid var(--gray-100);">
									<td style="padding: 1rem; color: var(--text-dark); font-weight: 600;"><%= idx + 1 %></td>
									<td style="padding: 1rem; color: var(--text-dark); max-width: 340px;">
										<div style="display: flex; align-items: center; gap: 0.5rem; min-width: 0;">
											<i class="fas fa-file-alt" aria-hidden="true" style="flex-shrink: 0;"></i>
											<span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; width: 100%;" title="<%= file.originalName %>"><%= file.originalName %></span>
										</div>
									</td>
									<td style="padding: 1rem; color: var(--text-dark);">
										<% 
																					let size = file.fileSize;
																					let sizeKB = (size / 1024).toFixed(2);
										%>
										<%= sizeKB %> KB
									</td>
									<td style="padding: 1rem; color: var(--text-dark);">
										<%= new Date(file.uploadedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %>
									</td>
									<td style="padding: 1rem; text-align: center;">
										<button class="file-action-btn" data-action="details" data-file-id="<%= file._id %>" data-file-name="<%= file.originalName %>" data-file-size="<%= file.fileSize %>" data-upload-date="<%= new Date(file.uploadedAt).toISOString() %>" style="background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 1rem; margin: 0 0.5rem;" title="File Details"><i class="fas fa-info-circle"></i></button>
										<a href="/files/<%= file._id %>" style="color: var(--primary-color); text-decoration: none; margin: 0 0.5rem;" title="Download"><i class="fas fa-download"></i></a>
										<button class="file-action-btn" data-action="delete" data-file-id="<%= file._id %>" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1rem; margin: 0 0.5rem;" title="Delete"><i class="fas fa-trash"></i></button>
										<button class="file-action-btn" data-action="rename" data-file-id="<%= file._id %>" data-file-name="<%= file.originalName %>" style="background: none; border: none; color: #f59e0b; cursor: pointer; font-size: 1rem; margin: 0 0.5rem;" title="Rename"><i class="fas fa-edit"></i></button>
										<button class="file-action-btn" data-action="share" data-file-id="<%= file._id %>" style="background: none; border: none; color: #10b981; cursor: pointer; font-size: 1rem; margin: 0 0.5rem;" title="Share"><i class="fas fa-share-alt"></i></button>
									</td>
								</tr>
							<% }); %>
						</tbody>
					</table>
				</div>
				<div style="margin-top: 1.5rem; text-align: center;">
					<a href="/files" class="btn btn-primary" style="display: inline-block; padding: 0.75rem 1.5rem;"><i class="fas fa-folder-open" aria-hidden="true"></i> View All Files</a>
				</div>
			<% } else { %>
				<div style="text-align: center; padding: 2rem; color: var(--text-light);">
					<p>No files yet. <a href="/files" style="color: var(--primary-color); text-decoration: none;">Upload your first file →</a></p>
				</div>
			<% } %>
		</div>

		<!-- Shared with you -->
		<div style="background: var(--white); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow); margin-top: 2rem;">
			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
				<h3 style="margin: 0;">Shared With You</h3>
			</div>
			<% const sharedList = Array.isArray(typeof sharedFiles !== 'undefined' ? sharedFiles : []) ? (typeof sharedFiles !== 'undefined' ? sharedFiles : []) : []; %>
			<% if (sharedList.length > 0) { %>
				<div style="overflow-x: auto;">
					<table style="width: 100%; border-collapse: collapse;">
						<thead>
							<tr style="border-bottom: 2px solid var(--gray-200);">
								<th style="text-align: left; padding: 1rem; color: var(--text-light); width: 50px;">#</th>
								<th style="text-align: left; padding: 1rem; color: var(--text-light);">File Name</th>
								<th style="text-align: left; padding: 1rem; color: var(--text-light);">Owner</th>
								<th style="text-align: left; padding: 1rem; color: var(--text-light);">Uploaded</th>
								<th style="text-align: center; padding: 1rem; color: var(--text-light);">Actions</th>
							</tr>
						</thead>
						<tbody>
							<% sharedList.forEach((file, idx) => { %>
								<tr style="border-bottom: 1px solid var(--gray-100);">
									<td style="padding: 1rem; color: var(--text-dark); font-weight: 600;"><%= idx + 1 %></td>
									<td style="padding: 1rem; color: var(--text-dark); max-width: 340px;">
										<div style="display: flex; align-items: center; gap: 0.5rem; min-width: 0;">
											<i class="fas fa-file-alt" aria-hidden="true" style="flex-shrink: 0;"></i>
											<span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; width: 100%;" title="<%= file.originalName %>"><%= file.originalName %></span>
										</div>
									</td>
									<td style="padding: 1rem; color: var(--text-dark);">
										<%= file.userId?.firstName || file.userId?.lastName ? `${file.userId.firstName || ''} ${file.userId.lastName || ''}`.trim() : (file.userId?.username || 'Owner') %>
									</td>
									<td style="padding: 1rem; color: var(--text-dark);">
										<%= new Date(file.uploadedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %>
									</td>
									<td style="padding: 1rem; text-align: center;">
										<a href="/files/<%= file._id %>" style="color: var(--primary-color); text-decoration: none; margin: 0 0.5rem;" title="Download"><i class="fas fa-download"></i></a>
									</td>
								</tr>
							<% }); %>
						</tbody>
					</table>
				</div>
			<% } else { %>
				<div style="text-align: center; padding: 2rem; color: var(--text-light);">
					<p>No shared files yet.</p>
				</div>
			<% } %>
		</div>

	</div>
</section>

<!-- Include shared file modals -->
<%- include('../partials/file-modals') %>

<script>
	// Toast notification functions - Define FIRST before file-operations.js loads
	function showError(msg) {
		console.error('Error:', msg);
		alert('Error: ' + msg);
	}

	function showSuccess(msg) {
		console.log('Success:', msg);
		alert('Success: ' + msg);
	}

	// Expose globally BEFORE file-operations.js
	window.showError = showError;
	window.showSuccess = showSuccess;
	
	console.log('[Dashboard] Helper functions initialized');
</script>

<!-- Load shared file operations AFTER helper functions -->
<script src="/js/file-operations.js"></script>

<script>
	// Dashboard-specific button handlers
	function bindDashboardButtons() {
		console.log('[Dashboard] Binding buttons...');
		
		const profileBtn = document.getElementById('dashboardProfileBtn');
		const uploadBtn = document.getElementById('dashboardUploadBtn');
		const quickUploadBtn = document.getElementById('quickUploadBtn');
		const refreshBtn = document.getElementById('dashboardRefreshBtn');
		const uploadFloatBtn = document.getElementById('uploadBtnFloat');
		
		if (profileBtn) profileBtn.addEventListener('click', () => window.location.href = '/profile');
		if (refreshBtn) refreshBtn.addEventListener('click', () => window.location.reload());
		
		// All upload buttons use the shared modal
		[uploadBtn, quickUploadBtn, uploadFloatBtn].forEach(btn => {
			if (btn) {
				console.log('[Dashboard] Found upload button:', btn.id);
				btn.addEventListener('click', () => {
					console.log('[Dashboard] Upload button clicked');
					if (window.openUploadModal) {
						window.openUploadModal();
					} else {
						console.error('[Dashboard] openUploadModal not found!');
					}
				});
			}
		});
		
		// Event delegation for file action buttons
		document.addEventListener('click', (e) => {
			// Handle file action buttons
			const actionBtn = e.target.closest('.file-action-btn');
			if (actionBtn) {
				e.preventDefault();
				const action = actionBtn.dataset.action;
				const fileId = actionBtn.dataset.fileId;
				const fileName = actionBtn.dataset.fileName;
				const fileSize = actionBtn.dataset.fileSize;
				const uploadDate = actionBtn.dataset.uploadDate;
				
				console.log('[Dashboard] Action button clicked:', action, fileId);
				
				switch(action) {
					case 'details':
						if (window.showFileDetails) {
							window.showFileDetails(fileId, fileName, parseInt(fileSize), uploadDate);
						}
						break;
					case 'delete':
						if (window.deleteFileFromDashboard) {
							window.deleteFileFromDashboard(fileId);
						}
						break;
					case 'rename':
						if (window.showRenameModal) {
							window.showRenameModal(fileId, fileName);
						}
						break;
					case 'share':
						if (window.showShareModal) {
							window.showShareModal(fileId);
						}
						break;
				}
				return;
			}
			
			// Handle modal close buttons
			const closeBtn = e.target.closest('.modal-close-btn');
			if (closeBtn) {
				e.preventDefault();
				const modalId = closeBtn.dataset.modal;
				if (modalId) {
					document.getElementById(modalId).style.display = 'none';
					console.log('[Dashboard] Closed modal:', modalId);
				}
				return;
			}
			
			// Handle modal action buttons
			const modalActionBtn = e.target.closest('.modal-action-btn');
			if (modalActionBtn) {
				e.preventDefault();
				const action = modalActionBtn.dataset.action;
				console.log('[Dashboard] Modal action:', action);
				
				if (action === 'confirmRename' && window.confirmRename) {
					window.confirmRename();
				} else if (action === 'confirmShare' && window.confirmShare) {
					window.confirmShare();
				} else if (action === 'copyShareLink' && window.copyShareLink) {
					window.copyShareLink();
				} else if (action === 'toggleProgressCollapse' && window.toggleProgressCollapse) {
					window.toggleProgressCollapse();
				} else if (action === 'toggleProgressVisibility' && window.toggleProgressVisibility) {
					window.toggleProgressVisibility();
				} else if (action === 'showProgressPanel' && window.toggleProgressVisibility) {
					window.toggleProgressVisibility();
				} else if (action === 'closeProgress' && window.hideProgressPopup) {
					window.hideProgressPopup();
				} else if (action === 'cancelAllUploads' && window.cancelAllUploads) {
					window.cancelAllUploads();
				}
				return;
			}
		});
		
		// Verify action functions are available
		const requiredFunctions = ['showFileDetails', 'deleteFileFromDashboard', 'showRenameModal', 'showShareModal'];
		requiredFunctions.forEach(fn => {
			if (typeof window[fn] !== 'function') {
				console.error(`[Dashboard] Missing function: ${fn}`);
			} else {
				console.log(`[Dashboard] ✓ ${fn} loaded`);
			}
		});
	}

	if (document.readyState === 'loading') {
		console.log('[Dashboard] Waiting for DOMContentLoaded...');
		document.addEventListener('DOMContentLoaded', bindDashboardButtons);
	} else {
		console.log('[Dashboard] DOM already loaded, binding now');
		bindDashboardButtons();
	}
</script>
